name: E2E Test

on:
  workflow_call:

permissions:
  contents: read
  pull-requests: write

jobs:
  e2e:
    name: E2E Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Run E2E tests
        id: e2e
        run: |
          go mod tidy

          echo "Running E2E tests..."

          # Run E2E tests and capture output
          test_exit_code=0
          if go test -v ./cmd/cobrayaml/... -run "TestE2E" -timeout 10m > e2e-output.txt 2>&1; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            test_exit_code=1
          fi

          # Always show output
          cat e2e-output.txt

          # Count passed/failed tests (use || true to avoid exit code 1 when no match)
          passed=$(grep -c "^--- PASS:" e2e-output.txt 2>/dev/null || true)
          failed=$(grep -c "^--- FAIL:" e2e-output.txt 2>/dev/null || true)
          passed=${passed:-0}
          failed=${failed:-0}
          total=$((passed + failed))

          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "failed=$failed" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

          # Extract test names for summary
          {
            echo "### Test Results"
            echo ""
            echo "| Test | Result |"
            echo "|------|--------|"
          } > e2e-summary.md

          grep -E "^--- (PASS|FAIL):" e2e-output.txt | while read -r line; do
            if echo "$line" | grep -q "PASS"; then
              test_name=$(echo "$line" | sed 's/--- PASS: //' | sed 's/ (.*//')
              echo "| \`$test_name\` | :white_check_mark: PASS |" >> e2e-summary.md
            else
              test_name=$(echo "$line" | sed 's/--- FAIL: //' | sed 's/ (.*//')
              echo "| \`$test_name\` | :x: FAIL |" >> e2e-summary.md
            fi
          done

          # Exit with failure if tests failed
          exit $test_exit_code

      - name: Comment on PR
        if: always() && github.event.pull_request != null
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            const status = '${{ steps.e2e.outputs.status }}' === 'success' ? 'SUCCESS' : 'FAILURE';
            const statusEmoji = status === 'SUCCESS' ? 'âœ…' : 'âŒ';
            const passed = '${{ steps.e2e.outputs.passed }}' || '0';
            const failed = '${{ steps.e2e.outputs.failed }}' || '0';
            const total = '${{ steps.e2e.outputs.total }}' || '0';

            // Read test summary
            let testSummary = '';
            try {
              testSummary = fs.readFileSync('e2e-summary.md', 'utf8');
            } catch (e) {
              testSummary = 'No test summary available';
            }

            // Read test output (truncate if too long)
            let testOutput = '';
            try {
              const fullOutput = fs.readFileSync('e2e-output.txt', 'utf8');
              if (fullOutput.length > 30000) {
                testOutput = fullOutput.substring(0, 30000) + '\n\n... (truncated)';
              } else {
                testOutput = fullOutput;
              }
            } catch (e) {
              testOutput = 'No test output available';
            }

            const comment = `## ðŸ§ª E2E Test Results

            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`

            ### ðŸ“Š Summary

            | Metric | Value |
            |--------|-------|
            | Status | ${statusEmoji} ${status} |
            | Passed | ${passed} |
            | Failed | ${failed} |
            | Total | ${total} |

            ${testSummary}

            <details>
            <summary>ðŸ“„ Full Test Output</summary>

            \`\`\`
            ${testOutput}
            \`\`\`

            </details>

            ---
            *Generated by GitHub Actions*`;

            const prNumber = context.payload.pull_request?.number || context.issue?.number;
            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ§ª E2E Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: Upload E2E test output
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-test-output
          path: |
            e2e-output.txt
            e2e-summary.md
          if-no-files-found: ignore
